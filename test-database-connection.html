<!DOCTYPE html>
<html>
<head>
    <title>Supabase ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Supabase ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ</h1>
    <div id="status">æ¥ç¶šä¸­...</div>
    <div id="results"></div>
    
    <button onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    <button onclick="addBarcodeColumn()">barcodeã‚«ãƒ©ãƒ ã‚’è¿½åŠ </button>
    <button onclick="completelyDeleteAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤</button>
    <button onclick="insertRealData()">å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥</button>
    <button onclick="testBarcodeSearch()">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ¤œç´¢ãƒ†ã‚¹ãƒˆ</button>

    <script>
        // Supabaseè¨­å®š
        const supabaseUrl = 'https://xkcaxrvnvefstzvpldzf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhrY2F4cnZudmVmc3R6dnBsZHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwNjc3ODYsImV4cCI6MjA2NTY0Mzc4Nn0.KPI-586rKSlcGTi9o2YWR1n1pxfaqoPaPouclCu6Q5I';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        function log(message) {
            document.getElementById('results').innerHTML += '<div>' + message + '</div>';
            console.log(message);
        }
        
        async function completelyDeleteAllData() {
            if (!confirm('âš ï¸ è­¦å‘Š: å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            log('ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤ä¸­...');
            document.getElementById('results').innerHTML = '';
            
            try {
                // ã¾ãšç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ã‚’ç¢ºèª
                const { data: currentSupps } = await supabase.from('supplements').select('id, name_ja, brand');
                if (currentSupps) {
                    log(`å‰Šé™¤å‰ã®ãƒ‡ãƒ¼ã‚¿: ${currentSupps.length}ä»¶`);
                    currentSupps.forEach(item => {
                        log(`- ${item.name_ja} (${item.brand})`);
                    });
                }
                
                // æ®µéšçš„ã«å‰Šé™¤
                log('1. user_supplementså‰Šé™¤ä¸­...');
                const { error: userError } = await supabase.from('user_supplements').delete().gte('created_at', '1900-01-01');
                if (userError) log('user_supplementså‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + userError.message);
                
                log('2. supplement_nutrientså‰Šé™¤ä¸­...');
                const { error: snError } = await supabase.from('supplement_nutrients').delete().gte('created_at', '1900-01-01');
                if (snError) log('supplement_nutrientså‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + snError.message);
                
                log('3. supplementså‰Šé™¤ä¸­...');
                const { error: suppError } = await supabase.from('supplements').delete().gte('created_at', '1900-01-01');
                if (suppError) log('supplementså‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + suppError.message);
                
                log('4. nutrientså‰Šé™¤ä¸­...');
                const { error: nutError } = await supabase.from('nutrients').delete().gte('created_at', '1900-01-01');
                if (nutError) log('nutrientså‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + nutError.message);
                
                // å‰Šé™¤ç¢ºèª
                const { data: remainingSupps } = await supabase.from('supplements').select('*');
                log(`âœ… å‰Šé™¤å®Œäº†! æ®‹ã‚Šã®ãƒ‡ãƒ¼ã‚¿: ${remainingSupps ? remainingSupps.length : 0}ä»¶`);
                
                if (remainingSupps && remainingSupps.length === 0) {
                    log('ğŸ‰ å…¨ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸï¼');
                } else {
                    log('âš ï¸ ä¸€éƒ¨ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã¾ã™');
                    if (remainingSupps && remainingSupps.length > 0) {
                        remainingSupps.forEach(item => {
                            log(`æ®‹å­˜ãƒ‡ãƒ¼ã‚¿: ${item.name_ja || item.name_en} (${item.brand})`);
                        });
                    }
                }
                
            } catch (err) {
                log('âŒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }
        
        async function addBarcodeColumn() {
            log('ğŸ”§ supplementsãƒ†ãƒ¼ãƒ–ãƒ«ã«barcodeã‚«ãƒ©ãƒ ã‚’è¿½åŠ ä¸­...');
            
            try {
                // SQLæ–‡ã‚’å®Ÿè¡Œã—ã¦barcodeã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
                const { data, error } = await supabase.rpc('exec_sql', {
                    sql: 'ALTER TABLE supplements ADD COLUMN IF NOT EXISTS barcode TEXT;'
                });
                
                if (error) {
                    log('âŒ ã‚«ãƒ©ãƒ è¿½åŠ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    log('ğŸ’¡ Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§æ‰‹å‹•ã§ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:');
                    log('ALTER TABLE supplements ADD COLUMN barcode TEXT;');
                } else {
                    log('âœ… barcodeã‚«ãƒ©ãƒ ã®è¿½åŠ ã«æˆåŠŸã—ã¾ã—ãŸ');
                }
            } catch (err) {
                log('âŒ ã‚«ãƒ©ãƒ è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + err.message);
                log('ğŸ’¡ Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§æ‰‹å‹•ã§ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:');
                log('ALTER TABLE supplements ADD COLUMN barcode TEXT;');
            }
        }
        
        async function testConnection() {
            document.getElementById('status').textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
            document.getElementById('results').innerHTML = '';
            
            try {
                // ç¾åœ¨ã®supplementsãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ³ã‚’ç¢ºèª
                const { data, error } = await supabase
                    .from('supplements')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    log('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    document.getElementById('status').textContent = 'æ¥ç¶šå¤±æ•—';
                } else {
                    log('âœ… æ¥ç¶šæˆåŠŸ');
                    log('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿æ•°: ' + (data ? data.length : 0));
                    if (data && data.length > 0) {
                        log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿: ' + JSON.stringify(data[0], null, 2));
                    }
                    document.getElementById('status').textContent = 'æ¥ç¶šæˆåŠŸ';
                }
            } catch (err) {
                log('âŒ ä¾‹å¤–ã‚¨ãƒ©ãƒ¼: ' + err.message);
                document.getElementById('status').textContent = 'æ¥ç¶šå¤±æ•—';
            }
        }
        
        async function insertRealData() {
            log('ğŸ”„ å®Ÿéš›ã®ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ä¸­...');
            
            try {
                // ã‚¹ãƒ†ãƒƒãƒ—0: barcodeã‚«ãƒ©ãƒ ã‚’è¿½åŠ ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
                log('0. barcodeã‚«ãƒ©ãƒ ã‚’è¿½åŠ ä¸­...');
                try {
                    await supabase.rpc('add_barcode_column');
                } catch (rpcError) {
                    log('âš ï¸ RPCå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¾ã™ã€‚');
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—1: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤
                log('1. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤ä¸­...');
                
                // ã‚ˆã‚Šç¢ºå®Ÿãªå‰Šé™¤æ–¹æ³•
                const { data: allSupplements } = await supabase.from('supplements').select('id');
                if (allSupplements && allSupplements.length > 0) {
                    log(`å‰Šé™¤å¯¾è±¡: ${allSupplements.length}ä»¶ã®ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ`);
                    
                    // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é †ç•ªã«å‰Šé™¤
                    await supabase.from('user_supplements').delete().gte('created_at', '1900-01-01');
                    await supabase.from('supplement_nutrients').delete().gte('id', '00000000-0000-0000-0000-000000000000');
                    await supabase.from('supplements').delete().gte('created_at', '1900-01-01');
                    await supabase.from('nutrients').delete().gte('created_at', '1900-01-01');
                    
                    log('âœ… å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†');
                } else {
                    log('âš ï¸ å‰Šé™¤å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—2: å®Ÿéš›ã®NOW Foodså•†å“ã‚’æŠ•å…¥ï¼ˆbarcodeã‚«ãƒ©ãƒ ãªã—ã§ï¼‰
                log('2. NOW Foodså•†å“ã‚’æŠ•å…¥ä¸­...');
                const { data: suppData, error: suppError } = await supabase
                    .from('supplements')
                    .insert([
                        {
                            dsld_id: 'DSLD_733739025401',
                            name_en: 'NOW Foods Propolis 1500',
                            name_ja: 'NOW Foods ãƒ—ãƒ­ãƒãƒªã‚¹ 1500',
                            brand: 'NOW Foods',
                            serving_size: '1 capsule',
                            category: 'supplements'
                        },
                        {
                            dsld_id: 'DSLD_19121619',
                            name_en: 'NOW Foods Vitamin C-1000 Sustained Release',
                            name_ja: 'NOW Foods ãƒ“ã‚¿ãƒŸãƒ³C-1000 å¾æ”¾æ€§',
                            brand: 'NOW Foods',
                            serving_size: '1 tablet',
                            category: 'vitamins'
                        },
                        {
                            dsld_id: 'DSLD_733739003737',
                            name_en: 'NOW Foods Vitamin D-3 5000 IU Softgels',
                            name_ja: 'NOW Foods ãƒ“ã‚¿ãƒŸãƒ³D-3 5000 IU ã‚½ãƒ•ãƒˆã‚¸ã‚§ãƒ«',
                            brand: 'NOW Foods',
                            serving_size: '1 softgel',
                            category: 'vitamins'
                        },
                        {
                            dsld_id: 'DSLD_733739012890',
                            name_en: 'NOW Foods Magnesium Glycinate',
                            name_ja: 'NOW Foods ãƒã‚°ãƒã‚·ã‚¦ãƒ ã‚°ãƒªã‚·ãƒãƒ¼ãƒˆ',
                            brand: 'NOW Foods',
                            serving_size: '1 tablet',
                            category: 'minerals'
                        },
                        {
                            dsld_id: 'DSLD_033674155103',
                            name_en: 'Nature\'s Way Vitamin C-1000',
                            name_ja: 'Nature\'s Way ãƒ“ã‚¿ãƒŸãƒ³C-1000',
                            brand: 'Nature\'s Way',
                            serving_size: '1 tablet',
                            category: 'vitamins'
                        }
                    ]);
                
                if (suppError) {
                    log('âŒ å•†å“æŠ•å…¥ã‚¨ãƒ©ãƒ¼: ' + suppError.message);
                } else {
                    log('âœ… å•†å“æŠ•å…¥æˆåŠŸ: ' + (suppData ? suppData.length : 0) + 'ä»¶');
                    
                    // æŠ•å…¥ç¢ºèªï¼šNOW Foodså•†å“æ•°ã‚’ãƒã‚§ãƒƒã‚¯
                    const { data: checkData, error: checkError } = await supabase
                        .from('supplements')
                        .select('*')
                        .eq('brand', 'NOW Foods');
                    
                    if (!checkError && checkData) {
                        log(`âœ… NOW Foodså•†å“ç¢ºèª: ${checkData.length}ä»¶æŠ•å…¥å®Œäº†`);
                        checkData.forEach(item => {
                            log(`- ${item.name_ja} (DSLD ID: ${item.dsld_id})`);
                        });
                    }
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—3: æ „é¤Šæˆåˆ†ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
                log('3. æ „é¤Šæˆåˆ†ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ä¸­...');
                const { data: nutData, error: nutError } = await supabase
                    .from('nutrients')
                    .insert([
                        { name_ja: 'ãƒ“ã‚¿ãƒŸãƒ³C', name_en: 'Vitamin C', category: 'vitamin', unit: 'mg' },
                        { name_ja: 'ãƒ“ã‚¿ãƒŸãƒ³D3', name_en: 'Vitamin D3', category: 'vitamin', unit: 'IU' },
                        { name_ja: 'ãƒ—ãƒ­ãƒãƒªã‚¹', name_en: 'Propolis', category: 'supplement', unit: 'mg' }
                    ]);
                
                if (nutError) {
                    log('âŒ æ „é¤Šæˆåˆ†æŠ•å…¥ã‚¨ãƒ©ãƒ¼: ' + nutError.message);
                } else {
                    log('âœ… æ „é¤Šæˆåˆ†æŠ•å…¥æˆåŠŸ');
                }
                
                log('âœ… ãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†ï¼');
                
            } catch (err) {
                log('âŒ ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }
        
        async function testBarcodeSearch() {
            log('ğŸ” ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ¤œç´¢ãƒ†ã‚¹ãƒˆ: 19121619');
            
            try {
                // ã‚¹ãƒ†ãƒƒãƒ—1: å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®å•†å“æ•°ã‚’ç¢ºèª
                const { data: allData, error: allError } = await supabase
                    .from('supplements')
                    .select('*');
                
                if (!allError && allData) {
                    log(`ğŸ“Š å…¨å•†å“æ•°: ${allData.length}ä»¶`);
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—2: dsld_idã§æ¤œç´¢
                log('ğŸ” DSLD_19121619ã§æ¤œç´¢ä¸­...');
                const { data, error } = await supabase
                    .from('supplements')
                    .select('*')
                    .eq('dsld_id', 'DSLD_19121619');
                
                if (error) {
                    log('âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error.message);
                } else {
                    log('ğŸ¯ DSLD_19121619ã®æ¤œç´¢çµæœ: ' + (data ? data.length : 0) + 'ä»¶');
                    if (data && data.length > 0) {
                        data.forEach(item => {
                            log('âœ… è¦‹ã¤ã‹ã£ãŸå•†å“: ' + item.name_ja + ' (DSLD ID: ' + item.dsld_id + ')');
                        });
                    } else {
                        log('âš ï¸ DSLD_19121619ã®å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—3: NOW Foodsãƒ–ãƒ©ãƒ³ãƒ‰ã§æ¤œç´¢
                log('ğŸ” NOW Foodsãƒ–ãƒ©ãƒ³ãƒ‰ã§æ¤œç´¢ä¸­...');
                const { data: brandData, error: brandError } = await supabase
                    .from('supplements')
                    .select('*')
                    .eq('brand', 'NOW Foods');
                
                if (brandError) {
                    log('âŒ ãƒ–ãƒ©ãƒ³ãƒ‰æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + brandError.message);
                } else if (brandData && brandData.length > 0) {
                    log('âœ… NOW Foodså•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ' + brandData.length + 'ä»¶');
                    brandData.forEach(item => {
                        log('- ' + item.name_ja + ' (DSLD ID: ' + item.dsld_id + ')');
                    });
                } else {
                    log('âš ï¸ NOW Foodså•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—4: éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ã§Vitamin Cã‚’æ¢ã™
                log('ğŸ” "Vitamin C"ã‚’å«ã‚€å•†å“ã‚’æ¤œç´¢ä¸­...');
                const { data: vitcData, error: vitcError } = await supabase
                    .from('supplements')
                    .select('*')
                    .or('name_ja.ilike.%ãƒ“ã‚¿ãƒŸãƒ³C%,name_en.ilike.%Vitamin C%');
                
                if (vitcData && vitcData.length > 0) {
                    log('âœ… ãƒ“ã‚¿ãƒŸãƒ³Cå•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ' + vitcData.length + 'ä»¶');
                    vitcData.forEach(item => {
                        log('- ' + item.name_ja + ' (ãƒ–ãƒ©ãƒ³ãƒ‰: ' + item.brand + ', DSLD ID: ' + item.dsld_id + ')');
                    });
                }
                
            } catch (err) {
                log('âŒ æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ã§æ¥ç¶šãƒ†ã‚¹ãƒˆ
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>